<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salão Elegance</title>
<style>
  :root{--bg:#0e0f12;--text:#e6e8eb;--soft:#16181d;--card:#1b1f26;--border:#2a2f3a}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header,footer{padding:12px 16px;background:var(--soft)}
  main{padding:16px}
  h2{margin:0 0 10px}
  section{margin:18px 0}
  .card{background:linear-gradient(180deg,#151922,#101319);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
  .price{font-weight:700}
  .cart-item{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:8px 0;padding:10px;border:1px solid var(--border);border-radius:10px;background:#12141a}
  .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  img{max-width:100%;display:block;border-radius:10px}
  label{display:block;margin:10px 0 6px;color:#cdd3db}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1116;color:var(--text);outline:none}
  button{cursor:pointer;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#1b2330;color:#dbe3ee}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:800px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<header>
  <h1>Salão Elegance</h1>
</header>

<main>
  <!-- Galeria -->
  <section id="galeria">
    <h2>Galeria</h2>
    <div class="gallery">
      <img src="https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=900&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1519014816548-bf5fe059798b?q=80&w=900&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1512496015851-a90fb38ba796?q=80&w=900&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1503951914875-452162b0f3f1?q=80&w=900&auto=format&fit=crop" alt="">
    </div>
  </section>

  <!-- Serviços -->
  <section id="servicos">
    <h2>Serviços</h2>
    <div id="servicosGrid"></div>
  </section>

  <!-- Carrinho -->
  <section id="carrinho">
    <h2>Carrinho</h2>
    <div id="cartItems"></div>
    <div>Total: <span id="cartTotal">R$ 0,00</span></div>
  </section>

  <!-- Agendamento -->
  <section id="agendamento">
    <h2>Agendamento online</h2>
    <div class="grid">
      <div>
        <label>Data</label>
        <input type="date" id="dataAgendamento" required />
      </div>
      <div>
        <label>Horário</label>
        <select id="horarioAgendamento" required>
          <option value="">— Selecione —</option>
          <option value="08:00">08:00</option>
          <option value="09:00">09:00</option>
          <option value="10:00">10:00</option>
          <option value="13:00">13:00</option>
          <option value="14:00">14:00</option>
          <option value="15:00">15:00</option>
        </select>
      </div>
      <div>
        <label>Seu nome</label>
        <input id="nomeCliente" placeholder="Nome do cliente" required />
      </div>
      <div>
        <label>Telefone (WhatsApp)</label>
        <input id="telCliente" placeholder="(99) 9 9999-9999" inputmode="tel" required />
      </div>
    </div>
    <div style="margin-top:14px">
      <button id="confirmarAgendamento">Confirmar agendamento</button>
    </div>
  </section>
</main>

<footer>© <span id="year"></span> Salão Elegance</footer>

<!-- Firebase modular -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getFirestore, doc, onSnapshot, runTransaction,
    collection, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // Configuração do Firebase (seus dados)
  const firebaseConfig = {
    apiKey: "AIzaSyBHBcJHtU_o8tjsJCSoCsO665M3N72mF8g",
    authDomain: "meusiteaki2025.firebaseapp.com",
    projectId: "meusiteaki2025",
    storageBucket: "meusiteaki2025.firebasestorage.app",
    messagingSenderId: "1059720978927",
    appId: "1:1059720978927:web:c4e5fde24aa95672d0161a",
    measurementId: "G-KD8EDDRLWZ"
  };

  // Inicialização
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Helpers
  const fmtBRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const $ = s => document.querySelector(s);

  // Serviços
  const SERVICOS = [
    { id:'corte', nome:'Corte', preco:30.00 },
    { id:'lavagem', nome:'Lavagem de Cabelo', preco:50.00 },
    { id:'alongamento', nome:'Alongamento', preco:20.50 },
    { id:'selagem', nome:'Selagem', preco:200.00 }
  ];
  const servicosGrid = $('#servicosGrid');
  function renderServicos(){
    servicosGrid.innerHTML = '';
    SERVICOS.forEach(s=>{
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div><strong>${s.nome}</strong></div>
          <div class="price">${fmtBRL(s.preco)}</div>
        </div>
        <div style="margin-top:8px">
          <button data-add="${s.id}">Adicionar</button>
        </div>
      `;
      servicosGrid.appendChild(div);
    });
  }

  // Carrinho
  let cart = [];
  const cartItemsEl = $('#cartItems');
  const cartTotalEl = $('#cartTotal');

  function renderCart(){
    cartItemsEl.innerHTML = '';
    cart.forEach(i=>{
      const row = document.createElement('div');
      row.className = 'cart-item';
      row.innerHTML = `
        <div>${i.nome} x${i.qtd} — ${fmtBRL(i.preco*i.qtd)}</div>
        <div style="display:flex;gap:6px">
          <button data-qty="${i.id}|-1">–</button>
          <button data-qty="${i.id}|1">+</button>
          <button data-del="${i.id}">Remover</button>
        </div>
      `;
      cartItemsEl.appendChild(row);
    });
    const total = cart.reduce((t,i)=>t+i.preco*i.qtd,0);
    cartTotalEl.textContent = fmtBRL(total);
  }
  function addToCart(id){
    const item = cart.find(x=>x.id===id);
    if(item) item.qtd++;
    else{
      const s = SERVICOS.find(x=>x.id===id);
      cart.push({ id:s.id, nome:s.nome, preco:s.preco, qtd:1 });
    }
    renderCart();
  }
  function changeQty(id, delta){
    const it = cart.find(x=>x.id===id);
    if(!it) return;
    it.qtd += delta;
    if(it.qtd<=0) cart = cart.filter(x=>x.id!==id);
    renderCart();
  }
  function removeFromCart(id){
    cart = cart.filter(x=>x.id!==id);
    renderCart();
  }

  // Delegação global de cliques (serviços/carrinho)
  document.addEventListener('click', (e)=>{
    const add = e.target.closest('[data-add]');
    if(add){ addToCart(add.getAttribute('data-add')); }
    const del = e.target.closest('[data-del]');
    if(del){ removeFromCart(del.getAttribute('data-del')); }
    const qty = e.target.closest('[data-qty]');
    if(qty){
      const [id,delta] = qty.getAttribute('data-qty').split('|');
      changeQty(id, Number(delta));
    }
  });

  // Agendamento
  const dataAgendamento = $('#dataAgendamento');
  const horarioAgendamento = $('#horarioAgendamento');
  const nomeCliente = $('#nomeCliente');
  const telCliente = $('#telCliente');
  const btnConfirmar = $('#confirmarAgendamento');

  let unsubscribe = null;

  // Ouve horários reservados da data e desabilita no select
  function ouvirReservasDia(ds){
    if(unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(doc(db,'reservas',ds),(snap)=>{
      const indisponiveis = snap.exists() ? (snap.data().horarios || []) : [];
      // reset
      Array.from(horarioAgendamento.options).forEach(opt=>{
        if(opt.value) opt.disabled = false;
      });
      // bloqueia reservados
      indisponiveis.forEach(h=>{
        const opt = Array.from(horarioAgendamento.options).find(o=>o.value===h);
        if(opt) opt.disabled = true;
      });
      // se o selecionado ficou inválido, limpa
      if(horarioAgendamento.value && horarioAgendamento.selectedOptions[0]?.disabled){
        horarioAgendamento.value = '';
      }
    });
  }

  // Confirmação: bloqueia horário + registra agendamento + WhatsApp
  btnConfirmar.addEventListener('click', async ()=>{
    const ds = dataAgendamento.value;
    const hora = horarioAgendamento.value;
    const nome = nomeCliente.value.trim();
    const telefone = telCliente.value.trim();

    if(!ds || !hora || !nome || !telefone){
      alert('Preencha todos os campos');
      return;
    }

    try {
      // 1) Bloquear horário na data (reservas/{YYYY-MM-DD}.horarios[])
      const refReserva = doc(db,'reservas',ds);
      await runTransaction(db, async (t)=>{
        const snap = await t.get(refReserva);
        let horarios = snap.exists() ? (snap.data().horarios || []) : [];
        if(horarios.includes(hora)) throw new Error('Horário já reservado');
        horarios.push(hora);
        t.set(refReserva, { horarios }, { merge:true });
      });

      // 2) Registrar agendamento (agendamentos)
      await addDoc(collection(db,'agendamentos'), {
        data: ds,
        hora: hora,
        nome: nome,
        telefone: telefone,
        status: 'Pendente',
        criadoEm: serverTimestamp()
      });

      // 3) WhatsApp
      const numeroLimpo = telefone.replace(/\D/g,'');
      const msg = `Olá ${nome}, seu agendamento foi confirmado para ${ds} às ${hora}.`;
      window.open(`https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(msg)}`,'_blank');

      alert('Agendamento confirmado!');
      horarioAgendamento.value = '';
    } catch(e) {
      alert('Não foi possível reservar: ' + (e?.message || e));
    }
  });

  // Inicialização de UI
  (function init(){
    document.getElementById('year').textContent = new Date().getFullYear();
    renderServicos();
    renderCart();

    const hoje = new Date();
    const yyyy = hoje.getFullYear();
    const mm = String(hoje.getMonth()+1).padStart(2,'0');
    const dd = String(hoje.getDate()).padStart(2,'0');
    dataAgendamento.min = `${yyyy}-${mm}-${dd}`;
    dataAgendamento.value = `${yyyy}-${mm}-${dd}`;
    ouvirReservasDia(dataAgendamento.value);

    dataAgendamento.addEventListener('change', ()=>{
      const ds = dataAgendamento.value;
      if(ds) ouvirReservasDia(ds);
    });
  })();

  // Cleanup listener ao sair
  window.addEventListener('beforeunload', ()=>{ try{ if(unsubscribe) unsubscribe(); }catch{} });
</script>
</body>
</html>
